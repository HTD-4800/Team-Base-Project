{% extends "FindMyFurryFriend/base.html" %}

{% block title %}Find My Furry Friend{% endblock %}

{% block header %}
  <a href="{% url 'lost_pet_list' %}" class="header-link">Find My Furry Friend</a>
{% endblock %}

{% block content %}
  <div class="container">
    <!-- Filter Form -->
    <form method="get" class="filter-form">
        {{ filter.form.as_p }}
        <button type="submit">Filter</button>
    </form>

    <!-- Filtered Results with Comment Section -->
    <ul class="pet-list">
        {% for pet in filter.qs %}
        <li>
            <div class="pet-card">
                <h3><a href="{% url 'lost_pet_detail' pet.id %}" class="pet-link">{{ pet.species }}</a></h3>

                <!-- Display comments for each pet -->
                <div class="comment-section">
                    <ul class="comment-list">
                        {% for comment in pet.comments.all %}
                            <li class="comment-item">{{ comment.user }}: {{ comment.text }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Add comment button and form for each pet -->
                <button class="btn btn-primary show-comment-form">Add Comment</button>
                <form method="post" action="{}" class="comment-form">
                    {% csrf_token %}
                    <input type="hidden" name="pet_id" value="{{ pet.id }}">
                    <div class="form-group">
                        <textarea class="form-control" name="comment" rows="3" placeholder="Add your comment..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Comment</button>
                </form>
            </div>
        </li>
        {% empty %}
        <li>No results found.</li>
        {% endfor %}
    </ul>

    <!-- Centered and Inline Links -->
    <div class="button-container">
        <a href="{% url 'add_lost_pet' %}" class="btn btn-success add-pet-link">Add a Lost Pet</a>
        <a href="/home" class="btn btn-secondary back-home-link">Back to Home</a>
    </div>
  </div>

  <style>
      /* Your existing styles remain unchanged */

      /* Additional styling for the comment form */
      .comment-form textarea {
          width: 100%;
          padding: 8px;
          margin-bottom: 10px;
          box-sizing: border-box;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
  </style>

  <script>
      document.addEventListener('DOMContentLoaded', function () {
          const commentButtons = document.querySelectorAll('.show-comment-form');
          commentButtons.forEach(function (button) {
              button.addEventListener('click', function () {
                  const commentForm = this.nextElementSibling;
                  commentForm.style.display = commentForm.style.display === 'none' ? 'block' : 'none';
              });
          });

          const commentForms = document.querySelectorAll('.comment-form');
          commentForms.forEach(function (form) {
              form.addEventListener('submit', function (event) {
                  event.preventDefault(); // Prevent the default form submission

                  // Get the form data
                  const formData = new FormData(this);

                  // Use JavaScript to update the UI with the new comment
                  const petId = formData.get('pet_id');
                  const commentText = formData.get('comment');
                  const commentList = this.parentElement.querySelector('.comment-list');
                  const newCommentItem = document.createElement('li');
                  newCommentItem.className = 'comment-item';
                  newCommentItem.textContent = commentText;
                  commentList.appendChild(newCommentItem);

                  // Clear the comment input
                  this.querySelector('textarea').value = '';
              });
          });
      });
  </script>
{% endblock %}
